/*!
* Data Aquarium Framework - Offline Data Processor
* Copyright 2017-2018 Code On Time LLC; Licensed MIT; http://codeontime.com/license
*/
(function(){function y(t){var i=n._htmlDecoder;return i||(i=n._htmlDecoder=document.createElement("textarea")),i.innerHTML=t,i.value}var n=$app,t,e=2147483647,f=Sys.CultureInfo.CurrentCulture.dateTimeFormat,r=Sys.CultureInfo.CurrentCulture.numberFormat,u,o=["None","Sum","Count","Average","Max","Min"],s=["Thumbnail","Link","Signature"],h=["Text","Password","RichText","Note","Static"],c=["Default","Required","Suggested","Allowed","Forbidden"],l=/([\w\,\.]+):([\s\S]*)/,a=/^(_match_|_donotmatch_)\:(\$all\$|\$any\$)$/,v=/(\*|\$\w+\$|=|~|<(=|>){0,1}|>={0,1})([\s\S]*?)(\0|$)/;t=n.odp={enabled:function(i){if(arguments.length&&(this._enabled=i),!this._checkedSettings&&typeof __settings!="undefined"){this._checkedSettings=!0;var r=__settings&&__settings.odp;r&&(r.enabled==!1&&(this._enabled=!1),r.pageSize&&(t._pageSize=r.pageSize))}return n.touch&&this._enabled!=!1},offline:function(){return!1},start:function(n){t.enabled(n);t.controllers={};t.functions={}},invoke:function(t,i){var a=this,l=t.get_servicePath(),h=i.url.substring(l.length+1),e=$.Deferred(),r,c=!0,u,o,f,s;return n.odp.enabled()&&(r=t.odp,r||h!="GetPage"||(u=t.tagged(/\odp\-enabled\-(\w+)\b/),u=u?u[1]:"auto",u!="none"&&(t._dataViewFieldParentId?(o=n.find(t._filterSource),o&&(r=o.odp)):(f=t.get_parentDataView(),f&&(t._filterSource&&(r=f.odp),r||(f.odp?r=f.odp:(r=new n.OfflineDataProcessor(t),r.enabled=u)))),!r&&t._isModal&&(s=$app.touch.dataView(),s&&(r=s.odp))),t.odp=r),r&&r.invoke({method:h,dataView:t,params:i,deferred:e})&&(c=!1)),c&&$.ajax(i).done(function(n){e.resolve(n)}).fail(function(n,t,i){e.reject(n,t,i)}),e.promise()},getControllers:function(n){function f(){var t=[];n.forEach(function(n){t.push(r[n])});u.resolve(t)}Array.isArray(n)||(n=[n]);var i=[],u=$.Deferred(),r=t.controllers;return n.forEach(function(n){r[n]||i.push(n)}),i.length?$.ajax({url:__servicePath+"/getcontrollerlist",method:"POST",cache:!1,dataType:"text",data:JSON.stringify({controllers:i})}).done(function(n){var t=JSON.parse(JSON.parse(n).d);t.forEach(function(n){var t=n.dataController,i,u;r[t.name]=t;i=t._map={key:{},fields:{},views:{}};u=t.key=[];t.fields.forEach(function(n){i.fields[n.name]=n;n.isPrimaryKey&&(u.push(n),i.key[n.name]=n)});t.views.forEach(function(n){i.views[n.id]=n})});f()}):f(),u.promise()},func:function(n){var i=t.functions[n];return i||(i=t.functions[n]=eval(n)),i},compare:function(n,t){return n==null?t==null?0:-1:t==null?1:(typeof n=="string"&&(n=n.toUpperCase()),typeof t=="string"&&(t=t.toUpperCase()),n<t)?-1:n>t?1:0},filters:{_regexCache:{},_inrange:function(){return!1},_like:function(n,i){if(n==null||i==null)return!1;var r=t.filters._regexCache[i],u;return r||(u=i,i.match(/^\%/)?(i=i.substring(1),i.match(/\%$/)?(i=i.substring(0,i.length-1),r=new RegExp(RegExp.escape(i),"i")):r=new RegExp(RegExp.escape(i)+"$","i")):i.match(/\%$/)?(i=i.substring(0,i.length-1),r=new RegExp("^"+RegExp.escape(i),"i")):r=new RegExp("^"+RegExp.escape(i)+"$","i"),t.filters._regexCache[u]=r),typeof n!="string"&&(n=n.toString()),n.match(r)!=null},beginswith:function(){return!1},doesnotbeginwith:function(){return!1},contains:function(){return!1},doesnotcontain:function(){return!1},endswith:function(){return!1},doesnotendwith:function(){return!1},between:function(){return!1},"in":function(){return!1},notin:function(){return!1},month1:function(){return!1},month2:function(){return!1},month3:function(){return!1},month4:function(){return!1},month5:function(){return!1},month6:function(){return!1},month7:function(){return!1},month8:function(){return!1},month9:function(){return!1},month10:function(){return!1},month11:function(){return!1},month12:function(){return!1},thismonth:function(){return!1},nextmonth:function(){return!1},lastmonth:function(){return!1},quarter1:function(){return!1},quarter2:function(){return!1},quarter3:function(){return!1},quarter4:function(){return!1},thisquarter:function(){return!1},lastquarter:function(){return!1},nextquarter:function(){return!1},thisyear:function(){return!1},nextyear:function(){return!1},lastyear:function(){return!1},yeartodate:function(){return!1},thisweek:function(){return!1},nextweek:function(){return!1},lastweek:function(){return!1},today:function(){return!1},yesterday:function(){return!1},tomorrow:function(){return!1},yesterday:function(){return!1},past:function(){return!1},future:function(){return!1},"true":function(){return!1},"false":function(){return!1},isempty:function(){return!1},isnotempty:function(){return!1}}};n.OfflineDataProcessor=function(n){var t=this;t._dataView=n;t._state="inactive";t._data={};t._dataLoadMap={};t._dataLoadedKeys={};t._log=[];t._tracking={}};n.OfflineDataProcessor.prototype={is:function(n){var t=this;if(arguments.length){if(n.match(/^:/))return n==":dirty"?t._log.length>0:t._state==n.substring(1);t._state=n}else return t._state},root:function(n){return arguments.length==1?this._dataView==n:this._dataView},invoke:function(n){var i=this,e,r=n.dataView,o=r._controller,u=r._lastArgs,s=this._dataView==r,f=n.method;return s?f=="GetPage"&&r.get_lastCommandName()=="New"?i.is("active"):f=="Execute"&&u&&u.CommandName.match(/^(Insert|Update)$/)&&(i._log.splice(0,0,n.params.data),i.is("inactive")):f=="Execute"&&u&&u.CommandName.match(/^(Insert|Update|Delete)$/)&&(i.is("active"),i._log.push(n.params.data),i._tracking[r._controller]=!0),f.match(/^(GetPage|Execute|GetListOfValues)$/)&&i.tracking(r)&&($.when(t.getControllers(o)).done(function(){$.when(i.getData(o,r.get_externalFilter())).done(function(){i.execute(n)})}),e=!0),!!e},tracking:function(n){return!!this._tracking[n._controller]},getData:function(i,r){function s(){var n=u._data[i];o.resolve(n)}function h(e){var o=t._pageSize||100;n.execute({controller:i,view:"offline",pageSize:o,pageIndex:e,requiresRowCount:e==0,externalFilter:r}).done(function(n){e==0&&(f=n.totalRowCount);u.addData(i,n[i]);f-=o;f<0?s():h(e+1)})}var u=this,o=$.Deferred(),f,e;return u._dataLoadMap[i]||(u._dataLoadMap[i]={}),e=r?JSON.stringify(r):"_all",u._dataLoadMap[i][e]?s():(u._dataLoadMap[i][e]=!0,u._dataLoadedKeys[i]={},h(0)),o.promise()},addData:function(n,i){var r=this,e=t.controllers[n],o=e.key,f=r._dataLoadedKeys[n],u=r._data[n];u||(u=r._data[n]=[]);i.forEach(function(n){var t=[];o.forEach(function(i){t.push(n[i.name])});t=t.join(",");f[t]||(f[t]=!0,u.push(n))})},execute:function(i){function a(n){i.deferred.resolve(JSON.stringify({d:n}))}var l=this,e=i.method,r=JSON.parse(y(i.params.data)),o=r.args,d=r.request,v=o?o.Values:null,p=t.controllers[r.controller],f=o?o.CommandName:null,k=p._map,s=[],w={},b=0,h,c,u;e=="Execute"?(h={Tag:null,Errors:[],Values:[],Canceled:!1,NavigateUrl:null,ClientScript:null,RowsAffected:0,Filter:null,SortExpression:null,RowNotFound:!1},f=="Update"||f=="Delete"?(v.forEach(function(n){k.key[n.Name]&&(s.length&&s.push("&&"),s.push("(this."+n.Name+"==params.p"+b+")"),w["p"+b++]=n.OldValue)}),l.select({from:p.name,where:{filter:s.toString(),params:w},limit:1,"delete":f=="Delete"}).done(function(n){var t=n[0];t&&f=="Update"&&v.forEach(function(n){n.Modified&&(t[n.Name]=n.NewValue)});h.RowsAffected=n.length;h.RowNotFound=n.length==0;a(h)})):f=="Insert"):e=="GetPage"?(c=r.request,c.Controller=r.controller,c.View=r.view,l._viewPage(c).done(function(n){delete n._fieldMap;delete n._metadataFilter;a(n)})):e=="GetListOfValues"?(u=r.request,u.Controller=r.controller,u.View=r.view,u.Distinct=!0,u.FieldFilter=[r.FieldName],l._viewPage(u).done(function(n){a(n)})):n.alert("Unknown method: "+e)},select:function(n){var c=this,l=$.Deferred(),f=n.from,e=n.where,a=e?e.filter:null,v=n.sort,u=typeof f=="string"?c._data[f]:f,r=[],o=[],s=n.index?[]:null,y,i,h;if(n.yield)r=n.yield;else{if(a){for(y=t.func("(function(params,rowIndex){return "+a+"})"),i=0;i<u.length;i++)if(h=u[i],y.call(h,e.params,i+1)&&r.push(h),s&&s.push(i+1),n.delete&&o.push(i),n.limit==r.length)break;for(i=o.length-1;i>=0;i--)u.splice(o[i],1)}else r=u.slice(0);v&&r.sort(t.func(c._sortFunc(v)))}return l.resolve(r,s),l.promise()},_sortFunc:function(n){var t=["(function(a,b){"],u=/(\w+)(\s+(asc|desc))?/ig,i,r=!0;for(t.push("var result=0;");i=u.exec(n);)r?r=!1:t.push("if (result != 0) return result;"),t.push(String.format("result = ($app.odp.compare(a.{0},b.{0}))",i[1])),i[3]&&i[3].match(/^desc/i)&&t.push("if (result != 0) result *=-1;");return t.push("return result;"),t.push("})"),t.join("\n")},_filterFunc:function(){var n=["(function(a,b){"];return n.push("})"),n.join("\n")},_viewPage:function(y){function at(){p=t.controllers[lt];b=it?p._map.views[it]:p.views[0]}function vt(n){var t=this;t.PageSize!=1e3||t.SortExpression||(t.SortExpression=n.sortExpression)}function yt(n){var t=this;t.Tag=n.Tag;t.PageOffset=n.PageOffset||0;t.RequiresMetaData=n.PageIndex==-1||n.RequiresMetaData;t.RequiresRowCount=n.PageIndex<0||n.RequiresRowCount;t.PageIndex=0;n.PageIndex==-2&&(n.PageIndex=0);t.PageSize=n.PageSize;n.RequiresPivot&&(t.RequiresPivot=!0,t.RequiresMetaData=!1,t.RequiresRowCount=!1,t.PageSize=Number.MAX_VALUE);n.PageIndex>0&&(t.PageIndex=n.PageIndex);t.Rows=[];t.Fields=[];t.SortExpression=n.SortExpression;t.GroupExpression=n.GroupExpression;t.Filter=n.Filter;t.SystemFilter=n.SystemFilter;t.TotalRowCount=-1;t.Views=[];t.ActionGroups=[];t.Categories=[];t.Controller=n.Controller;t.View=n.View;t.LastView=n.LastView;t.ViewType=n.ViewType;t.SupportsCaching=n.SupportsCaching;t.QuickFindHint=n.QuickFindHint;t.InnerJoinPrimaryKey=n.InnerJoinPrimaryKey;t.InnerJoinForeignKey=n.InnerJoinForeignKey;t.RequiresSiteContentText=n.RequiresSiteContentText;t.FieldFilter=n.FieldFilter;t._metadataFilter=n.MetadataFilter;t.Distinct=n.Distinct}function k(n){var t=this._metadataFilter;return t==null||t.indexOf(n)!=-1}function rt(){var n=this,t=[];return n.Distinct||n.Fields.forEach(function(n){n.IsPrimaryKey&&t.push(n)}),t}function pt(n){var i=this,t=n.Expressions=[];k.call(n,"expressions")&&p.expressions.forEach(function(i){(i.ViewId==null||i.ViewId==n.View)&&t.push(i)})}function ut(n){var t=this,i=t.HeaderText||t.Label||t.Name;return i=i.replace(/\s/g,""),n=new RegExp("^"+RegExp.escape(n.replace(/\s/g,"")),"i"),i.match(n)}function wt(n){var t=b.categories||[];t.forEach(function(t,i){n.Categories.push({Id:t.id,Index:i,HeaderText:t.headerText,Description:t.description?t.description["@value"]:null,Tab:t.tab,Wizard:t.wizard,Flow:t.flow,Wrap:t.wrap==!0,Floating:t.floating==!0,Collapsed:t.collpased==!0})});t.length||n.Categories.push({Id:null,Index:0})}function bt(){}function g(n){var t=n;return n!=null&&n.match(/^%js%/)&&(t=JSON.parse(n.substring(4))),t}function ft(n){return n=="null"||n=="%js%null"}function et(t,i){var o={},h=0,c=i.QuickFindHint,e=!0,s=0,w=!0,y="&&",p=!1,b=i.Filter,u=[];return i.Fields.every(function(n){var t=n.SearchOptions;if(t&&t.match(/\$quickfind(?!disabled)/))return p=!0,!1}),b&&b.forEach(function(t){var yt=t.match(a),gt,rt,st,pt,ht,wt,et,at,kt,dt,it,vt,b,tt,ri,ot;if(yt&&(gt=yt[1]=="_donotmatch_",gt&&w&&(w=!1,e||u.push(")\n"),s>0&&u.push(")\n"),(!e||s>0)&&u.push("&&\n"),s=0,u.push(" !\n"),e=!0),s==0?(e||u.push(") &&\n"),u.push("(\n")):(u.push(")\n"),u.push("||\n")),y=yt[2]=="$all$"?" && ":" || ",s++,e=!0),rt=t.match(l),rt&&(st=!0,pt=" || ",rt[2].match(/>\|</)&&(pt=" && "),ht=rt[2].match(v),ht)){var k=rt[1],d=ht[1],b=ht[3];if(d=="~"&&k=="_quickfind_"&&(k=i.Fields[0].Name),wt=k.match(/,/),et=i._fieldMap[k],(et!=null&&et.AllowQBE!=!1||d=="~")&&(i.DistinctValueFieldName!=et.Name||s>0||d=="~"||i.AllowDistinctFieldInFilter)||wt)if(st?(e?(u.push("(\n"),e=!1):u.push(y),u.push("("),st=!1):u.push(pt),wt){var ni=k.substring(0,k.indexOf(",")),ui=k.substring(ni.length+1),fi=ni+t.indexOf(":");bt(ui,i,u,fi)}else if(d=="~"){b=g(b);for(var ct=[],ti=[ct],ei=new RegExp(RegExp.escape(r.NumberGroupSeparator+r.CurrencyGroupSeparator+r.CurrencySymbol),"gi"),oi=Unicode.w+RegExp.escape(f.DateSeparator+f.TimeSeparator+r.NumberDecimalSeparator),ii=new RegExp("\\s*(((\")(.+?)\")|((\\')(.+?)\\')|(,|;|(^|\\s+)-)|(["+oi+"]+))","gi"),nt=ii.exec(b),lt=!1;nt;)at=nt[1].trim(),at==","||at==";"?(ct=[],ti.push(ct),lt=!1):at=="-"?lt=!0:(kt="=",nt[3]||nt[6]||(kt=" "),dt=" ",lt&&(dt="-",lt=!1),it=nt[4],it==null&&(it=nt[7]),it==null&&(it=nt[10]),ct.push(dt+kt+it)),nt=ii.exec(b);vt=!0;ti.forEach(function(t){vt?vt=!1:u.push("||\n");u.push("(\n");var r=!0;t.forEach(function(t){var s=t.charAt(0)=="-",l=t.charAt(1)=="=",w="like",f,a,v,b,y,g,nt;l&&(w="=");f=t.substring(2);v=f.match(/^(.+)\:(.+)$/);v&&(a=v[1],b=!1,i.Fields.every(function(n){if(n.AllowQBE!=!1&&!n.AliasName||!(n.IsPrimaryKey&&n.Hidden&&ut.call(n))){b=!0;return}}),b?f=v[2]:a=null);var tt=Date.tryParseFuzzyDate(f),rt=tt!=null,it=!0,e,k,d=f;d=d.replace(ei,"");k=parseFloat(d);y=!isNaN(k);l||f.match(/%/)||(f="%"+f+"%");r?r=!1:u.push("&&");s&&u.push("!");u.push("(");g=!1;c&&c.match(/^;/)||i.Fields.forEach(function(t){var r=t.SearchOptions,c,v,i;t.AllowQBE==!1||t.AliasName||t.IsPrimaryKey&&t.Hidden&&(!t.Type.match(/^Date/)||rt)||(!a||ut.call(t,a))&&((p||r)&&r.match(/\$quickfinddisabled/)&&(!p||r||!r.match(/\$quickfind/))||(g=!0,e||(e="p"+h++,o[e]=f),l&&y&&(o[e]=k),l&&(!t.Type.match(/String/)&&!y||t.Type.match(/String/)&&y)||(it?it=!1:u.push("||"),t.Type.match(/^Date/)?(c="p"+h++,o[c]=n.stringifyDate(tt),s&&u.push("(",t.Name," != null)&&"),u.push("(",t.Name," = ",c)):(v=!1,w!="="&&t.Type=="String"&&t.Len>0&&t.Len<f.length&&(i=f,i=i.substring(1),t.Len<i.length&&(i=i.substring(0,i.length-1)),i.length>t.Len?v=!0:(nt=e,e="p"+h++,o[e]=i)),s&&u.push("(this.",t.Name,"!= null)&&"),w=="="?u.push("(this.",t.Name,"==","params.",e,")"):u.push("$app.odp.filters._like(this.",t.Name,",","params.",e,")")),nt&&(e=nt))))});c&&c.match(/\;/);g||(s&&c.match(/^\;/)?u.push("1=1"):u.push("1=0"));u.push(")\n")});u.push(")\n")});vt&&u.push("1=1")}else d.match(/^$/)?(tt="p"+h++,b=g(b),b!=null&&typeof b=="string"&&(b=b.split(/\$(or|and)\$/g)),o[tt]=b,u.push("($app.odp.filters.",d.substring(d.length-1),"(this.",k,",params.",tt,")")):(tt="p"+h++,o[tt]=g(b),ri=d=="="&&et.Type.match(/^DateTime/)&&b,d=="<>"&ft(b)?u.push("this.",k," != null"):d=="="&&ft(b)?u.push("this.",k," == null"):(ot="_equals",d=="*"?ot="_like":ri&&(ot="_inrange"),ot=="_equals"?u.push("this.",k,"==params.",tt):u.push("$app.odp.filters.",ot,"(this.",k,",params.",tt,")")))}st||u.push(")\n")}),s&&(u.push(")\n"),u.push(")\n"),e=!0),e||u.push(")\n"),{filter:u.join(""),params:o}}function ot(n){var t=n.SortExpression||"",i=rt.call(n);return i.forEach(function(n){n.IsPrimaryKey&&(t.length&&(t+=","),t+=n.Name)}),t}function kt(n,t){var i=$.Deferred(),u;if(n.SyncKey==null||!n.SyncKey.length||t.PageSize<0)return i.resolve(t),i.promise();if(st(t),u=rt.call(t),u.length==n.SyncKey.length){var r=[],f={},e=0;u.forEach(function(t,i){r.length&&r.push("&&");r.push("(this."+t.Name+"==params.p"+e+")");f["p"+e++]=n.SyncKey[i]});d.select({from:t.Controller,where:et(n,t),sort:ot(t)}).done(function(n){d.select({from:n,where:{filter:r.toString(),params:f},index:!0,limit:1}).done(function(r,u){r.length&&(t.PageIndex=Math.floor((u[0]-1)/t.PageSize),t.PageOffset=0);i.resolve(t,n)})})}else i.resolve(t);return i.promise()}function st(n){gt(n);ni(n)}function nt(n,t){var i={Name:n.name,Type:n.type},r,u;return t&&(i.Hidden=t==!0),n.length!=null&&(i.Len=n.length),n.label&&(i.Label=n.label),n.isPrimaryKey!=null&&(i.IsPrimaryKey=n.isPrimaryKey==!0),n.readOnly!=null&&(i.ReadOnly=n.readOnly==!0),n.onDemand!=null&&(i.OnDemand=n.onDemand==!0),n.default!=null&&(i.HasDefaultValue=!0),n.allowNulls!=!1&&(i.AllowNulls=!0),n.hidden!=null&&(i.Hidden=n.hidden==!0),n.allowQBE!=null&&(i.AllowQBE=n.allowQBE!=!1),n.allowLEV!=null&&(i.AllowLEV=n.allowLEV==!0),n.allowSorting!=null&&(i.AllowSorting=n.allowSorting!=!1),n.sourceFields!=null&&(i.SourceFields=n.sourceFields),n.onDemandStyle&&(i.OnDemandStyle=s.indexOf(n.onDemandStyle)),n.onDemandHandler&&(i.OnDemandHandler=n.onDemandHandler),n.contextFields&&(i.ContextFields=n.ContextFields),n.showInSummary!=null&&(i.ShowInSummary=n.showInSummary),n.htmlEncode!=null&&(i.htmlEncode=n.htmlEncode!=!1),n.calculated!=null&&(i.Calculated=n.calculated),n.causesCalculated!=null&&(i.CausesCalculated=n.causesCalculated==!0),n.isVirtual!=null&&(i.IsVirtual=n.isVirtual==!0),n.configuration&&(i.Configuration=n.configuration["@value"]),n.dataFormatString&&(i.DataFormatString=n.dataFormatString),n.formatOnClient!=null&&(i.FormatOnClient=n.formatOnClient==!0),r=n.items,r&&(r.dataController&&(i.ItemsDataController=r.dataController),r.targetController&&(i.ItemsTargetController=r.targetController)),u=n.dataView,u&&(i.DataViewController=u.controller,i.DataViewId=u.view,i.DataViewFilterFields=u.filterFields,i.AllowQBE=!0,i.AllowSorting=!0,i.Len=0,i.Columns=0,i.HtmlEncode=!0),i}function gt(n){if(!n.Fields.length){var t=b.dataFields,i={};b.categories&&b.categories.length&&(t=[],(b.categories||[]).forEach(function(n,r){(n.dataFields||[]).forEach(function(n){t.push(n);i[n.fieldName]=r})}));t||(t=[]);t.forEach(function(t){var e=p._map.fields[t.fieldName],r,f,s,u;e&&(r=nt(e),t.hidden!=null&&(r.Hidden=t.hidden==!0),t.dataFormatString!=null&&(r.DataFormatString=t.dataFormatString),t.formatOnClient!=null&&(r.FormatOnClient=t.formatOnClient!=!1),t.dataFormatString&&!r.DataFormatString&&(r.DataFormatString=dt.dataFormatString),t.headerText&&(r.HeaderText=t.headerText["@value"]),t.footerText&&(r.FooterText=t.footerText["@value"]),t.toolTip&&(r.toolTip=t.toolTip),t.watermark&&(r.Watermark=t.watermark),t.hyperlinkFormatString&&(r.HyperlinkFormatString=t.hyperlinkFormatString),t.aliasFieldName&&(r.AliasName=t.aliasFieldName),t.tag&&(r.Tag=t.tag),t.AllowQBE!=null&&(r.AllowQBE=t.allowQBE==!0),t.AllowSorting!=null&&(r.AllowSorting=t.allowSorting==!0),i[r.Name]!=null&&(r.CategoryIndex=i[r.Name]),t.columns!=null&&(r.Columns=t.columns),t.rows!=null&&(r.Rows=t.rows),t.textMode!=null&&(r.TextMode=h.indexOf(t.textMode)),t.readOnly!=null&&(r.ReadOnly=t.readOnly),t.aggregate&&(r.Aggregate=o.indexOf(t.aggregate)),t.search&&(r.Tag=(r.Tag?r.Tag+" ":"")+"search-mode-"+c.indexOf(t.search).ToLowerCase()),t.searchOptions&&(r.SearchOptions=t.searchOptions),f=t.items||e.items,f!=null&&(f.dataController&&(r.ItemsDataController=f.dataController),f.dataView&&(r.ItemsDataView=f.dataView),f.dataValueField&&(r.ItemsDataValueField=f.dataValueField),f.dataTextField&&(r.ItemsDataTextField=f.dataTextField),f.style&&(r.ItemsStyle=f.style),f.newDataView&&(r.ItemsNewDataView=f.newDataView),f.targetController&&(r.ItemsTargetController=f.targetController),f.copy&&(r.Copy=f.copy),f.pageSize&&(r.ItemsPageSize=f.pageSize),f.letters!=null&&(r.ItemsLetters=f.letters==!0),s=f.list,s&&s.length&&(r.Items=[],s.forEach(function(n){r.Items.push([n.value,n.text])})),f.autoSelect!=null&&(r.AutoSelect=f.autoSelect==!0),f.searchOnStart!=null&&(r.SearchOnStart=f.searchOnStart==!0),f.description&&(r.ItemsDescription=f.description)),n.Fields.push(r),u=e.dataView,u&&(u.showInSummary!=null&&(r.DataViewShowInSummary=u.showInSummary==!0),u.showActionBar!=null&&(r.DataViewShowActionBar=u.showActionBar!=!1),u.showActionButtons&&(r.DataViewShowActionButtons=u.showActionButtons),u.showDescription!=null&&(r.DataViewShowDescription=!0),u.showViewSelector!=null&&(r.DataViewShowViewSelector=u.showViewSelector!=!1),u.showModalForms!=null&&(r.DataViewShowModalForms=u.showModalForms==!0),u.searchByFirstLetter!=null&&(r.DataViewSearchByFirstLetter=u.searchByFirstLetter==!0),u.searchOnStart!=null&&(r.SearchOnStart=u.searchOnStart==!0),u.pageSize!=null&&(r.DataBViewPageSize=u.pageSize),u.multiSelect&&(r.DataViewMultiSelect=u.multiSelect==!0),u.showPager!=null&&(r.DataViewShowPager=dataVIew.showPager==!0),u.showPageSize!=null&&(r.DataViewShowPageSize=u.showPageSize!=!1),u.showSearchBar!=null&&(r.DataViewShowSearchBar=u.showSearchBar!=!1),u.showQuickFind!=null&&(r.DataViewShowQuickFind=u.showQuickFind!=!1),u.showRowNumber!=null&&(r.DataViewShowRowNumber=u.showRowNumber==!0),u.autoSelectFirstRow!=null&&(r.DataViewAutoSelectFirstRow=u.autoSelectFirstRow==!0),u.autoHighlightFirstRow!=null&&(r.DataViewAutoHighlightFirstRow=u.autoHighlightFirstRow==!0)),n.RequiresPivot)})}}function ni(t){function u(n){typeof n=="string"&&(n=p._map.fields[n]);n&&!r[n.name]&&(i.push(nt(n,!0)),r[n.name]=i[i.length-1])}function o(t,i){if(t)for(var r=n._fieldMapRegex.exec(t);r;)u(r[i]),r=n._fieldMapRegex.exec(t)}var e;p.statusBar&&(t.statusBar=p.startBar);var f=p.fields,i=t.Fields,r=t._fieldMap={};f.length||f.forEach(function(n){i.push(nt(n))});i.forEach(function(n){r[n.Name]=n});f.forEach(function(n){(n.isPrimaryKey||n.hidden)&&!r[n.name]&&u(n)});i.forEach(function(n){var t=n.AliasName,i;t&&(i=r[t],i?i.Hidden=!0:u(t))});e=b.groupExpression;e&&e.split($app._simpleListRegex).forEach(function(n){u(n)});i.forEach(function(n){o(n.Copy,1);o(n.Configuration,2)})}function ti(n,t){if(t.Distinct){for(var i=0;i<t.Fields.length;)t.Fields[i].IsPrimaryKey?t.Fields.splice(i,1):i++;t.Fields.push({Name:"group_count_",Type:"Double"})}}function ii(t,i){var r="",u;return i[t.Name]==null&&(r="null"),u=t.SourceFields.split(n._simpleListRegex),u.forEach(function(n){r.length&&(r+="|");var t=i[n];r+=t==null?"null":t.toString()}),r}function ri(){}function ui(){for(var n=0;n<w.Fields.length;n++)if(w.Fields[n].Aggregate)return!0;return!1}function fi(){}function ht(n){var t={Id:n.id,Type:n.type,Label:n.label};return n.headerText&&(t.HeaderText=n.headerText["@value"]),n.group!=null&&(t.Group=n.group),n.tags&&(t.Tags=n.tags),n.showInSelector==!1&&(t.ShowInSelector=!1),t}function ei(n){var t={Id:n.id};return n.commandName&&(t.CommandName=n.commandName),n.commandArgument!=null&&(t.CommandArgument=n.commandArgument),n.headerText&&(t.HeaderText=n.headerText),n.description&&(t.Description=n.description),n.cssClass&&(t.CssClass=n.cssClass),n.confirmation&&(t.Confirmation=n.confirmation),n.notify&&(t.Notify=n.notify),n.whenLastCommandName&&(t.WhenLastCommandName=n.whenLastCommandName),n.whenLastCommandArgument&&(t.WhenLastCommandArgument=n.whenLastCommandArgument),n.causesValidation!=null&&(t.CausesValidation=n.causesValidation!=!1),n.whenKeySelected!=null&&(t.WhenKeySelected=n.whenKeySelected==!0),n.whenTag&&(t.WhenTag=n.whenTag),n.whenHRef&&(t.WhenHRef=n.whenHRef),n.whenView&&(t.WhenView=n.whenView),n.whenClientScript&&(t.WhenClientScript=n.whenClientScript),n.key&&(t.key=n.key),t}function oi(n){var t={Id:n.id,Actions:[],Scope:n.scope};return n.headerText&&(t.HeaderText=n.headerText),n.flat==!0&&(t.Flat=!0),n.actionGroup&&n.actionGroup.forEach(function(n){t.Actions.push(ei(n))}),t}function si(){var n=this,r=n.Fields,i=n.FieldFilter,t;i&&i.length&&(t=[],r.forEach(function(n){(n.IsPrimaryKey||vi(n.Name))&&t.push(n)}),n.Fields=t,n.FieldFilter=null)}function hi(){var n=this,t=n.ItemsStyle;return n.ItemsDataController&&!(t=="AutoComplete"||t=="Lookup")}function ci(n,i){var b=this,l,y,s,e,r,o,a;if(!k("items"))return!1;if(l=hi.call(n),l&&ct.call(b,n),l){if(u)return!0;u=!0;try{if(s=n.ContextFields,s){for(var h=[],p=/(\w+)\s*=\s*(.+?)($|,)/,f=p.match(s),c={};f;){if(e=f[2].match(/^(\'(.+?)\'|(\d+))$/),e)r=c[e[1]],r||(r=c[e[1]]=[]),r.push(e[2]);else if(i&&(i.every(function(n){if(n.Name==f[2])return n.NewValue==null?(i=null,!1):(h.push(f[1]+":=%js%"+JSON.stringify(n.NewValue)),!1)}),!i))return!0;f=p.match(s)}for(fieldName in c){for(r=c[fieldName],o=0;o<r.length-1;o++)r[o]=JSON.stringify(r[o]);r.length==1?h.push(fieldName+":="+r[0]):h.push(fieldName+":$in$"+r.join("$or$"))}y=h}a=null;n.ItemsTargetController||n.ItemsDataView||(a=n.ItemsDataTextField);var v=n.ItemsDataController,g=n.ItemsDataView,w=$.Deferred();return $.when(t.getControllers(v)).done(function(){$.when(d.getData(v)).done(function(){d._viewPage({Controller:v,View:g,PageIndex:0,PageSize:1e3,SortExpression:a,Filter:y,RequiresMetaData:!0,MetadataFilter:["fields"]}).done(function(t){w.resolve(n,t)})})}),w.promise()}finally{u=!1}}return!1}function li(){var n={},t=this.Fields;for(i=0;i<t.length;i++)n[t[i].Name]=i;return n}function ai(t,i){var o;t.Items||(t.Items=[]);var c=this,u=t.ItemsDataValueField,r=t.ItemsDataTextField,h=t.Items;u||i.Fields.every(function(n){if(n.IsPrimaryKey)return u=n.Name,!1});r||i.Fields.every(function(n){if(n.Type=="String")return r=n.Name,!1});r||(r=i.Fields[0].Name);var f=li.call(i),s=[f[u],f[r]],e=t.Copy;if(e)for(m=n._fieldMapRegex.exec(e);m;)o=f[m[2]],o!=null&&s.push(o),m=n._fieldMapRegex.exec(e);i.Rows.forEach(function(n){var t=[];s.forEach(function(i){t.push(n[i])});h.push(t)})}function ct(){var n=this}function vi(n){var t=this.FieldFilter;return!t||t.indexOf(n)}function yi(t){function s(){o.resolve(i)}var o=$.Deferred(),f=[],i=this,r=i.Fields,e,u;return i.RequiresMetaData?(k.call(i,"views")&&t.views&&t.views.forEach(function(n){if(!n.virtualViewId){var t=ht(n);i.Views.push(ht(n));t.Id==i.View&&(i.ViewHeaderText=t.HeaderText)}}),k.call(i,"layouts")&&b.layout&&(i.ViewLayout=b.layout["@value"]),k.call(i,"actions")&&t.actions&&t.actions.forEach(function(n){i.ActionGroups.push(oi(n))}),k(i,"items")&&(e=[],u=i.NewRow,!u&&i.Rows.length&&(u=i.Rows[0]),u!=null&&r.forEach(function(n,t){e.push({Name:n.Name,Value:u[t]})}),r.forEach(function(n){if(n.ItemsStyle=="CheckBoxList"||n.ItemsTargetController||b.type=="Form"){var t=ci.call(i,n,e);typeof t!="boolean"&&f.push(t)}}),f.length&&$.when.apply($,f).done(function(){for(var n=0;n<arguments.length;n++)ai.call(w,arguments[n][0],arguments[n][1]);s()}))):(r=[],i.Expressions=null),k.call(i,"fields")?r.forEach(function(n){n.Formula&&delete n.Formula;ct.call(i,n)}):r.splice(0,r.length),i.IsAuthenticated=!!n.userName(),f.length||s(),o.promise()}var d=this,w={},tt=$.Deferred(),lt=y.Controller,p,it=y.View,b;return at(),vt.call(y,w),yt.call(w,y),pt.call(p,w),w.RequiresMetaData&&k.call(w,"categories")&&wt(w),kt(y,w).done(function(n,t){st(n);si.call(n);ti(y,n);var r=n.SupportsCaching&&n.PageSize!=e,i=n.PageSize*n.PageIndex+n.PageOffset,u=n.PageSize,f=2;r&&i>n.PageSize&&(i-=n.PageSize);r&&(i>n.PageSize&&(f=3),u=n.PageSize*f);d.select({from:n.Controller,where:et(y,n),sort:ot(n),yield:t}).done(function(t){for(var h,e,r,o,a,v,c,l,s,f=i;f<i+u&&f<t.length;f++){for(h=t[f],e=[],r=0;r<n.Fields.length;r++)o=n.Fields[r],e[r]=h[o.Name],o.SourceFields&&(e[r]=ii(o,h));n.RequiresPivot?ri.call(n,e):n.Rows.push(e)}a=n.RequiresRowCount&&!(y.Inserting||y.DoesNotRequireData);a&&(n.TotalRowCount=t.length);!y.DoesNotRequireAggregates&&ui.call(n)&&(v=n.Aggregates=[],c=[],n.Fields.forEach(function(n,t){n.Aggregate&&c.push({field:n,index:t,map:{},sum:0,count:0,min:null,max:null})}),t.forEach(function(n){c.forEach(function(t){var u=t.field,i=n[u.Name],r;switch(u.Aggregate){case 1:i!=null&&(r=t.sum+=i);break;case 2:i==null||t.map[i]||(r=++t.count,t.map[i]=!0);break;case 3:i!=null&&(t.sum+=i,r=t.sum/++t.count);break;case 4:i!=null&&(t.max==null||t.max<i)&&(r=t.max=i);break;case 5:i!=null&&(t.min==null||t.min>i)&&(r=t.min=i)}r!=null&&(v[t.index]=r)})}));y.RequiresFirstLetters&&n.ViewType!="Form"&&(n.RequiresRowCount?(l={},s=[],letterField=n.Fields[0],t.forEach(function(n){var t=n[letterField.Name],i;t!=null&&(typeof t!="string"&&(t=t.toString()),t.length&&(i=t.substring(0,1),l[i]||(s.push(i),l[i]=!0)))}),s.sort(),n.FirstLetters=s.join(",")):n.FirstLetters="");y.Inserting?n.NewRow=[]:fi(n);yi.call(n,p).done(function(n){tt.resolve(n)})})}),tt.promise()}};n.odp.start(!1)})();